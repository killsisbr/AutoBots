<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Mensagens - Restaurante</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        :root {
            --cor-primaria: #ff6b35;
            --cor-secundaria: #2c3e50;
            --cor-fundo: #1a1a1a;
            --cor-texto: #ffffff;
            --cor-card: #2c2c2c;
            --cor-sucesso: #27ae60;
            --cor-aviso: #f39c12;
            --cor-erro: #e74c3c;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            min-height: 100vh;
        }

        .restaurant-header {
            background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria));
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .restaurant-name {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .restaurant-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0.5rem 0 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .controls {
            background: var(--cor-card);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            color: #bdc3c7;
            font-weight: 500;
        }

        .filter-input {
            padding: 0.8rem;
            border: 2px solid #34495e;
            border-radius: 8px;
            background: #1a1a1a;
            color: var(--cor-texto);
            font-size: 1rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--cor-primaria);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--cor-primaria);
            color: white;
        }

        .btn-primary:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--cor-card);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--cor-primaria);
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--cor-primaria);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 1rem;
        }

        .messages-container {
            background: var(--cor-card);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .messages-header {
            background: var(--cor-primaria);
            padding: 1rem 1.5rem;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .messages-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .message-item {
            padding: 1.5rem;
            border-bottom: 1px solid #34495e;
            transition: background 0.3s ease;
        }

        .message-item:hover {
            background: rgba(255, 107, 53, 0.1);
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .message-from {
            font-weight: bold;
            color: var(--cor-primaria);
            font-size: 1.1rem;
        }

        .message-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .message-type {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .type-recebida {
            background: var(--cor-sucesso);
            color: white;
        }

        .type-enviada {
            background: var(--cor-primaria);
            color: white;
        }

        .type-sistema {
            background: var(--cor-aviso);
            color: white;
        }

        .message-content {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid var(--cor-primaria);
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #7f8c8d;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: var(--cor-erro);
            font-size: 1.2rem;
        }

        .empty {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .message-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="restaurant-header">
        <h1 class="restaurant-name" id="restaurant-name">Carregando...</h1>
        <p class="restaurant-subtitle">Histórico de Mensagens</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="filter-group">
                <label class="filter-label">Buscar mensagens:</label>
                <input type="text" id="search-input" class="filter-input" placeholder="Digite para buscar...">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Tipo:</label>
                <select id="type-filter" class="filter-input">
                    <option value="">Todos</option>
                    <option value="recebida">Recebidas</option>
                    <option value="enviada">Enviadas</option>
                    <option value="sistema">Sistema</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Data:</label>
                <input type="date" id="date-filter" class="filter-input">
            </div>
            
            <button class="btn btn-primary" onclick="mensagensApp.loadMensagens()">
                🔄 Atualizar
            </button>
        </div>

        <div class="stats-grid" id="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="total-messages">0</div>
                <div class="stat-label">Total de Mensagens</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="messages-today">0</div>
                <div class="stat-label">Hoje</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="received-messages">0</div>
                <div class="stat-label">Recebidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sent-messages">0</div>
                <div class="stat-label">Enviadas</div>
            </div>
        </div>

        <div class="messages-container">
            <div class="messages-header">
                📱 Histórico de Mensagens
            </div>
            <div class="messages-list" id="messages-list">
                <div class="loading">
                    <p>📨 Carregando mensagens...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MensagensPersonalizadas {
            constructor() {
                this.restaurantId = this.getRestaurantId();
                this.restaurant = null;
                this.mensagens = [];
                this.filteredMensagens = [];
                this.init();
            }

            getRestaurantId() {
                const urlParts = window.location.pathname.split('/');
                if (urlParts[1] === 'r' && urlParts[2]) {
                    return urlParts[2];
                }
                
                const params = new URLSearchParams(window.location.search);
                return params.get('restaurant') || 'brutus-burger';
            }

            async init() {
                try {
                    await this.loadRestaurantInfo();
                    await this.loadMensagens();
                    this.setupFilters();
                    this.renderMensagens();
                    this.updateStats();
                } catch (error) {
                    console.error('Erro ao carregar mensagens:', error);
                    this.showError('Erro ao carregar mensagens. Tente novamente.');
                }
            }

            async loadRestaurantInfo() {
                try {
                    const response = await fetch(`/api/restaurant/${this.restaurantId}`);
                    if (response.ok) {
                        this.restaurant = await response.json();
                        this.applyRestaurantTheme();
                    } else {
                        this.restaurant = {
                            id: this.restaurantId,
                            nome: 'Restaurante',
                            cores: {
                                primaria: '#ff6b35',
                                secundaria: '#2c3e50',
                                fundo: '#1a1a1a'
                            }
                        };
                    }
                } catch (error) {
                    console.error('Erro ao carregar info do restaurante:', error);
                }
            }

            applyRestaurantTheme() {
                if (!this.restaurant) return;

                document.getElementById('page-title').textContent = `Mensagens - ${this.restaurant.nome}`;
                document.getElementById('restaurant-name').textContent = this.restaurant.nome;

                if (this.restaurant.cores) {
                    const root = document.documentElement;
                    root.style.setProperty('--cor-primaria', this.restaurant.cores.primaria);
                    root.style.setProperty('--cor-secundaria', this.restaurant.cores.secundaria);
                    root.style.setProperty('--cor-fundo', this.restaurant.cores.fundo);
                }
            }

            async loadMensagens() {
                const response = await fetch(`/api/mensagens?restaurant=${this.restaurantId}`);
                if (!response.ok) {
                    throw new Error('Falha ao carregar mensagens');
                }
                this.mensagens = await response.json();
                this.filteredMensagens = [...this.mensagens];
            }

            setupFilters() {
                const searchInput = document.getElementById('search-input');
                const typeFilter = document.getElementById('type-filter');
                const dateFilter = document.getElementById('date-filter');

                [searchInput, typeFilter, dateFilter].forEach(element => {
                    element.addEventListener('input', () => this.applyFilters());
                });
            }

            applyFilters() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const typeFilter = document.getElementById('type-filter').value;
                const dateFilter = document.getElementById('date-filter').value;

                this.filteredMensagens = this.mensagens.filter(mensagem => {
                    const matchesSearch = !searchTerm || 
                        mensagem.conteudo.toLowerCase().includes(searchTerm) ||
                        mensagem.remetente.toLowerCase().includes(searchTerm);
                    
                    const matchesType = !typeFilter || mensagem.tipo === typeFilter;
                    
                    const matchesDate = !dateFilter || 
                        new Date(mensagem.data_criacao).toDateString() === new Date(dateFilter).toDateString();

                    return matchesSearch && matchesType && matchesDate;
                });

                this.renderMensagens();
                this.updateStats();
            }

            renderMensagens() {
                const messagesList = document.getElementById('messages-list');
                
                if (!this.filteredMensagens || this.filteredMensagens.length === 0) {
                    messagesList.innerHTML = '<div class="empty">📭 Nenhuma mensagem encontrada.</div>';
                    return;
                }

                const html = this.filteredMensagens.map(mensagem => this.renderMensagem(mensagem)).join('');
                messagesList.innerHTML = html;
            }

            renderMensagem(mensagem) {
                const date = new Date(mensagem.data_criacao);
                const formattedDate = date.toLocaleString('pt-BR');
                
                return `
                    <div class="message-item">
                        <div class="message-header">
                            <div class="message-from">${mensagem.remetente || 'Sistema'}</div>
                            <div class="message-type type-${mensagem.tipo || 'sistema'}">${this.getTypeLabel(mensagem.tipo)}</div>
                            <div class="message-date">${formattedDate}</div>
                        </div>
                        <div class="message-content">${this.formatMessageContent(mensagem.conteudo)}</div>
                    </div>
                `;
            }

            getTypeLabel(tipo) {
                const labels = {
                    'recebida': '📥 Recebida',
                    'enviada': '📤 Enviada',
                    'sistema': '⚙️ Sistema'
                };
                return labels[tipo] || '📨 Mensagem';
            }

            formatMessageContent(content) {
                // Escapar HTML e quebrar linhas
                return content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
            }

            updateStats() {
                const total = this.mensagens.length;
                const today = new Date().toDateString();
                const todayMessages = this.mensagens.filter(m => 
                    new Date(m.data_criacao).toDateString() === today
                ).length;
                
                const received = this.mensagens.filter(m => m.tipo === 'recebida').length;
                const sent = this.mensagens.filter(m => m.tipo === 'enviada').length;

                document.getElementById('total-messages').textContent = total;
                document.getElementById('messages-today').textContent = todayMessages;
                document.getElementById('received-messages').textContent = received;
                document.getElementById('sent-messages').textContent = sent;
                document.getElementById('stats-grid').style.display = 'grid';
            }

            showError(message) {
                document.getElementById('messages-list').innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // Instância global para acesso nos botões
        let mensagensApp;

        document.addEventListener('DOMContentLoaded', () => {
            mensagensApp = new MensagensPersonalizadas();
        });
    </script>
</body>
</html>