<!DOCTYPE html>
<html>
<head>
    <title>Teste API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: white; }
        button { padding: 10px 20px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #result { background: #333; padding: 20px; margin: 20px 0; border-radius: 5px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🧪 Teste da API</h1>
    <button onclick="testarAPI()">Testar /api/mensagens</button>
    <button onclick="testarGatilhos()">Testar /api/gatilhos</button>
    <button onclick="limpar()">Limpar</button>
    
    <div id="result"></div>

    <script>
        const result = document.getElementById('result');
        
        function log(message) {
            console.log(message);
            result.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
        }
        
        function limpar() {
            result.textContent = '';
        }
        
        // Sistema Multi-Tenant - Obter clienteId da sessão
        async function getClienteId() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const data = await response.json();
                    return data.id;
                }
            } catch (error) {
                console.error('Erro ao obter clienteId:', error);
            }
            return null;
        }

        // Função auxiliar para construir URLs de API com clienteId
        async function buildApiUrl(endpoint) {
            const clienteId = await getClienteId();
            if (!clienteId) {
                throw new Error('Cliente não autenticado');
            }
            const separator = endpoint.includes('?') ? '&' : '?';
            return `${endpoint}${separator}clienteId=${clienteId}`;
        }
        
        async function testarAPI() {
            log('🚀 Testando /api/mensagens...');
            
            try {
                const apiUrl = await buildApiUrl('/api/mensagens');
                const response = await fetch(apiUrl);
                log(`📡 Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ Sucesso! Recebidas ${data.length} mensagens`);
                    log(`📄 Dados: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const error = await response.text();
                    log(`❌ Erro: ${error}`);
                }
            } catch (error) {
                log(`💥 Exceção: ${error.message}`);
            }
        }
        
        async function testarGatilhos() {
            log('🚀 Testando /api/gatilhos...');
            
            try {
                const apiUrl = await buildApiUrl('/api/gatilhos');
                const response = await fetch(apiUrl);
                log(`📡 Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ Sucesso! Recebidos ${data.length} gatilhos`);
                    log(`📄 Dados: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const error = await response.text();
                    log(`❌ Erro: ${error}`);
                }
            } catch (error) {
                log(`💥 Exceção: ${error.message}`);
            }
        }
        
        log('🎯 Página carregada. Clique nos botões para testar.');
    </script>
</body>
</html>